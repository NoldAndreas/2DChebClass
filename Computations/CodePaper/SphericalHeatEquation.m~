function SphericalHeatEquation()

close all

N = 50;
L = 2;

tMax = 1;

plotTimes = 0:tMax/20:tMax;

PhysArea.N = N;
PhysArea.L = L;

aLine = InfSpectralLineSpherical(PhysArea);

PlotArea = struct('N',200,'yMin',0,'yMax',10);

[Pts,Diff,Int,Ind,Interp] = aLine.ComputeAll(PlotArea); 

Dy = Diff.Dy;
DDy = Diff.DDy;
y = Pts.y;
yCut = cut(y);

sigma = 1;
a = 1;

u0Full = (sigma*sqrt(2*pi))^(-3)*exp(-y.^2/(2*sigma^2));
u0 = cut(u0Full);

opts = odeset('RelTol',10^-6,'AbsTol',10^-6);

[~,U_t] =  ode15s(@du_dt,plotTimes,u0,opts);

for iPlot = 1:length(plotTimes);
    subplot(1,2,1)
    ut = mirror(U_t(iPlot,:).');
    plot(Interp.pts,Interp.InterPol*ut,'b');
    hold on
    plot(yCut,U_t(iPlot,:),'go');
    plot(Interp.pts,uExact(Interp.pts,plotTimes(iPlot)),'-r');
    ylim([0,0.1]);
    xlim([0,max(Interp.pts)]);
    
    
    uEx = uExact(y,plotTimes(iPlot))
    
    pause
    
    subplot(1,2,2);
    %m = L1norm(ut);

    relErr = L1norm(ut-uEx);
    hold on
    plot(plotTimes(iPlot),relErr,'x');
    
end


    function dudt = du_dt(t,u)
        u = mirror(u);
        dudt = 2*(Dy*u)./y + DDy*u;
        dudt(Ind.infinite,:)   = u(Ind.infinite,:) - u0Full(Ind.infinite,:);
        dudt = cut(dudt);
        dudt = dudt(:);
    end

    function xOut = mirror(x)
        % flip for negative spatial part
        xOut = [flipdim(x,1); x];
    end

    function xOut = cut(x)
        % remove negative spatial part
        xOut = x(end/2+1:end,:);
    end

    function u = uExact(r,t)
        u = 8*pi^(3/2)*(2*pi*a*sigma*sqrt(2*t))^(-3) ...
            .* exp(-r.^2/(4*a^2*t)) ...
            .* exp(r.^2*sigma^2/(8*a^4*t^2 + 4*a^2*sigma^2*t)) ...
            .*(1/a^2 + 2*t/sigma^2)^(-3/2);
    end

    function Norm = L1norm(u)
        integrand = y.^2.*u;
        integrand(~isfinite(y)) = 0;
        Norm = 0.5*4*pi*Int*(integrand);
    end

end

